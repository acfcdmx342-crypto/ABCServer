<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Catálogos Administrativos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { --dark: #0f172a; --accent: #38bdf8; }
        body { background: #f1f5f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow-x: hidden; }
        
        .sidebar { 
            width: 240px; 
            min-height: 100vh; 
            background: var(--dark); 
            color: white; 
            position: fixed; 
            z-index: 1000; 
            transition: all 0.3s;
            left: 0;
        }
        
        .sidebar a { color: #94a3b8; text-decoration: none; padding: 12px 20px; display: block; transition: 0.3s; cursor: pointer; font-size: 0.9rem; }
        .sidebar a:hover { background: #1e293b; color: var(--accent); }
        .sidebar a.active { color: white; border-left: 4px solid var(--accent); background: #1e293b; }
        
        .main-content { 
            margin-left: 240px; 
            padding: 20px; 
            transition: all 0.3s;
        }

        @media (max-width: 768px) {
            .sidebar { left: -240px; }
            .sidebar.active { left: 0; }
            .main-content { margin-left: 0; }
            .main-content.shifted { margin-left: 0; filter: blur(2px); pointer-events: none; }
        }

        .table-container { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); min-height: 300px; }
        .sticky-col { position: sticky; left: 0; background: white; font-weight: bold; border-right: 2px solid #e2e8f0 !important; z-index: 1; }
        th { font-size: 0.7rem; color: #64748b; text-transform: uppercase; text-align: center; background: #f8fafc !important; }
        td { vertical-align: middle; text-align: center; font-size: 0.85rem; }
        input[type="text"], input[type="email"], select, textarea { text-transform: uppercase; }
        input[type="password"] { text-transform: none; }

        .btn-toggle {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1001;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        @media (max-width: 768px) { .btn-toggle { display: block; } }
    </style>
</head>
<body>

<button class="btn btn-dark btn-toggle" onclick="toggleSidebar()">
    <i class="bi bi-list fs-4"></i>
</button>

<div class="sidebar" id="sidebar">
    <div class="text-center py-4 border-bottom border-secondary mb-2">
        <h6 class="mb-0 fw-bold text-white">CATÁLOGOS</h6>
    </div>
    <a onclick="render('matriz')" id="link-matriz"><i class="bi bi-hdd-network me-2"></i> Matriz Tecnología</a>
    <a onclick="render('zonas')" id="link-zonas"><i class="bi bi-geo-alt me-2"></i> Zonas</a>
    <a onclick="render('empresas')" id="link-empresas"><i class="bi bi-building me-2"></i> Empresas</a>
    <a onclick="render('sucursales')" id="link-sucursales"><i class="bi bi-shop me-2"></i> Sucursales</a>
    <a onclick="render('usuarios')" id="link-usuarios"><i class="bi bi-person-lines-fill me-2"></i> Usuarios</a>
</div>

<div class="main-content" id="main-content">
    <div id="view" class="table-container">
        <div class="text-center py-5 text-muted">
            <i class="bi bi-cloud-check display-1"></i>
            <h4 class="mt-3">Bienvenido al Sistema</h4>
            <p>Selecciona un módulo en el menú lateral.</p>
        </div>
    </div>
</div>

<div class="modal fade" id="modalApp" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title" id="mTitle">Registro</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="fID">
                
                <div class="row">
                    <div id="secEmpresa" class="col-md-6 mb-3 d-none">
                        <label class="form-label fw-bold small">Empresa</label>
                        <select id="fEmp" class="form-select"></select>
                    </div>
                    <div id="secZona" class="col-md-6 mb-3 d-none">
                        <label class="form-label fw-bold small">Zona</label>
                        <select id="fZona" class="form-select"></select>
                    </div>

                    <div id="secUsuarios" class="d-none row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold small">Departamento</label>
                            <input type="text" id="uDep" class="form-control" placeholder="EJ. SISTEMAS">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold small">Puesto</label>
                            <input type="text" id="uPue" class="form-control" placeholder="EJ. GERENTE">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold small">Usuario Acceso</label>
                            <input type="text" id="uUsu" class="form-control" placeholder="USUARIO">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold small">Contraseña</label>
                            <input type="password" id="uPass" class="form-control">
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-bold small">Correo Electrónico</label>
                            <input type="email" id="uCor" class="form-control" placeholder="CORREO@EMPRESA.COM">
                        </div>
                    </div>

                    <div id="secIndividual" class="col-12 mt-3">
                        <label class="form-label fw-bold small" id="lblNom">Nombre / Descripción</label>
                        <input type="text" id="fNom" class="form-control" placeholder="NOMBRE COMPLETO O DESCRIPCIÓN">
                    </div>

                    <div id="secMasivo" class="col-12 d-none mt-3">
                        <div class="alert alert-info py-2 small"><i class="bi bi-info-circle me-1"></i> Uno por línea.</div>
                        <textarea id="fMasivo" class="form-control" rows="5"></textarea>
                    </div>

                    <div id="secToggleMasivo" class="col-12 form-check form-switch d-none mt-3 ms-3">
                        <input class="form-check-input" type="checkbox" id="checkMasivo">
                        <label class="form-check-label small fw-bold" for="checkMasivo">Activar Carga Masiva</label>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button class="btn btn-primary w-100" id="btnSave">Guardar Información</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const config = { databaseURL: "https://abcservers-2927d-default-rtdb.firebaseio.com/" };
    const db = getDatabase(initializeApp(config));

    let store = { servidores: {}, zonas: {}, empresas: {}, sucursales: {}, usuarios: {} };
    let currentPath = '';

    Object.keys(store).forEach(path => {
        onValue(ref(db, path), (s) => {
            store[path] = s.val() || {};
            if (currentPath === path) render(path);
        });
    });

    const updateZonasDropdown = (selectedEmpresa, selectedZona = "") => {
        const fZona = document.getElementById("fZona");
        const zonasFiltradas = Object.values(store.zonas).filter(z => z.empresa === selectedEmpresa).map(z => z.nombre).sort();
        fZona.innerHTML = zonasFiltradas.length > 0 ? zonasFiltradas.map(z => `<option value="${z}" ${selectedZona === z ? 'selected' : ''}>${z}</option>`).join('') : '<option value="">SIN ZONAS</option>';
    };

    document.getElementById("fEmp").onchange = (e) => updateZonasDropdown(e.target.value);
    document.getElementById("checkMasivo").onchange = (e) => {
        document.getElementById("secIndividual").classList.toggle('d-none', e.target.checked);
        document.getElementById("secMasivo").classList.toggle('d-none', !e.target.checked);
    };

    window.render = (path) => {
        currentPath = path;
        document.querySelectorAll('.sidebar a').forEach(el => el.classList.remove('active'));
        document.getElementById(`link-${path}`)?.classList.add('active');

        const items = store[path];
        const keys = Object.keys(items);

        let html = `<div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="fw-bold m-0">${path.toUpperCase()}</h4>
                        <button class="btn btn-dark" onclick="showModal('${path}')"><i class="bi bi-plus-lg"></i> Nuevo</button>
                    </div>`;

        if (keys.length === 0) {
            html += `<div class="text-center py-5 text-muted">No hay registros</div>`;
        } else {
            html += `<div class="table-responsive"><table class="table table-hover border">
                <thead><tr>
                    ${path === 'usuarios' || path === 'sucursales' || path === 'zonas' ? '<th>Empresa</th>' : ''}
                    ${path === 'usuarios' || path === 'sucursales' ? '<th>Zona</th>' : ''}
                    ${path === 'usuarios' ? '<th>Depto</th>' : ''}
                    <th class="sticky-col text-start">Nombre</th>
                    ${path === 'usuarios' ? '<th>Usuario</th><th>Puesto</th>' : ''}
                    <th class="text-end">Acciones</th>
                </tr></thead><tbody>`;

            keys.forEach(id => {
                const r = items[id];
                html += `<tr>
                    ${path === 'usuarios' || path === 'sucursales' || path === 'zonas' ? `<td><small>${r.empresa || '-'}</small></td>` : ''}
                    ${path === 'usuarios' || path === 'sucursales' ? `<td><small>${r.zona || '-'}</small></td>` : ''}
                    ${path === 'usuarios' ? `<td><small>${r.departamento || '-'}</small></td>` : ''}
                    <td class="sticky-col text-start">${r.nombre}</td>
                    ${path === 'usuarios' ? `<td>${r.usuarioAcceso || '-'}</td><td>${r.puesto || '-'}</td>` : ''}
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-secondary border-0" onclick="showModal('${path}', '${id}')"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-outline-danger border-0" onclick="del('${path}', '${id}')"><i class="bi bi-trash"></i></button>
                    </td>
                </tr>`;
            });
            html += `</tbody></table></div>`;
        }
        document.getElementById("view").innerHTML = html;
    };

    window.showModal = (path, id = "") => {
        const item = id ? store[path][id] : {};
        document.getElementById("fID").value = id;
        document.getElementById("fNom").value = item.nombre || "";
        document.getElementById("mTitle").innerText = (id ? 'Editar ' : 'Nuevo ') + path.slice(0, -1);
        
        // Reset de secciones
        ['secEmpresa', 'secZona', 'secUsuarios', 'secMasivo', 'secToggleMasivo'].forEach(s => document.getElementById(s).classList.add('d-none'));
        document.getElementById("secIndividual").classList.remove('d-none');
        document.getElementById("checkMasivo").checked = false;

        if (path === 'zonas' || path === 'sucursales' || path === 'usuarios') {
            document.getElementById("secEmpresa").classList.remove('d-none');
            const emps = Object.values(store.empresas).map(e => e.nombre).sort();
            document.getElementById("fEmp").innerHTML = emps.map(e => `<option value="${e}" ${item.empresa === e ? 'selected' : ''}>${e}</option>`).join('');
        }

        if (path === 'sucursales' || path === 'usuarios') {
            document.getElementById("secZona").classList.remove('d-none');
            updateZonasDropdown(item.empresa || document.getElementById("fEmp").value, item.zona);
        }

        if (path === 'usuarios') {
            document.getElementById("secUsuarios").classList.remove('d-none');
            document.getElementById("uDep").value = item.departamento || "";
            document.getElementById("uPue").value = item.puesto || "";
            document.getElementById("uUsu").value = item.usuarioAcceso || "";
            document.getElementById("uPass").value = item.password || "";
            document.getElementById("uCor").value = item.correo || "";
            document.getElementById("lblNom").innerText = "Nombre Completo";
        } else {
            document.getElementById("lblNom").innerText = "Nombre / Descripción";
        }

        if (path === 'sucursales' && !id) document.getElementById("secToggleMasivo").classList.remove('d-none');

        new bootstrap.Modal(document.getElementById("modalApp")).show();
    };

    document.getElementById("btnSave").onclick = async () => {
        const id = document.getElementById("fID").value;
        const nombre = document.getElementById("fNom").value.trim().toUpperCase();
        const isMasivo = document.getElementById("checkMasivo").checked;

        if(!nombre && !isMasivo) return Swal.fire("Error", "El nombre es requerido", "error");

        let data = { nombre };
        if (['zonas', 'sucursales', 'usuarios'].includes(currentPath)) data.empresa = document.getElementById("fEmp").value;
        if (['sucursales', 'usuarios'].includes(currentPath)) data.zona = document.getElementById("fZona").value;

        if (currentPath === 'usuarios') {
            data.departamento = document.getElementById("uDep").value.trim().toUpperCase();
            data.puesto = document.getElementById("uPue").value.trim().toUpperCase();
            data.usuarioAcceso = document.getElementById("uUsu").value.trim();
            data.password = document.getElementById("uPass").value;
            data.correo = document.getElementById("uCor").value.trim().toUpperCase();
        }

        try {
            if (isMasivo) {
                const nombres = document.getElementById("fMasivo").value.split('\n').map(n => n.trim().toUpperCase()).filter(n => n);
                for (let n of nombres) await push(ref(db, currentPath), { ...data, nombre: n });
            } else {
                id ? await update(ref(db, `${currentPath}/${id}`), data) : await push(ref(db, currentPath), data);
            }
            bootstrap.Modal.getInstance(document.getElementById("modalApp")).hide();
            Swal.fire({ icon: "success", title: "Guardado", timer: 1000, showConfirmButton: false });
        } catch (e) { Swal.fire("Error", e.message, "error"); }
    };

    window.del = async (path, id) => {
        const res = await Swal.fire({ title: '¿Eliminar?', icon: 'warning', showCancelButton: true });
        if (res.isConfirmed) await remove(ref(db, `${path}/${id}`));
    };

    window.toggleSidebar = () => {
        document.getElementById('sidebar').classList.toggle('active');
        document.getElementById('main-content').classList.toggle('shifted');
    };
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
