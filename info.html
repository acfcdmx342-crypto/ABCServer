<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Control de Empresas - Matriz</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { --dark: #0f172a; --accent: #38bdf8; --orange-header: #ffb100; }
        body { background: #f1f5f9; font-family: 'Segoe UI', sans-serif; }
        
        .main-content { padding: 20px; transition: all 0.3s; }
        .table-container { 
            background: white; 
            border-radius: 8px; 
            padding: 0; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
            overflow: hidden;
        }

        /* Estilo similar a la imagen */
        .header-orange {
            background-color: var(--orange-header);
            color: black;
            font-weight: bold;
            text-align: center;
            padding: 5px;
            font-size: 0.8rem;
            text-transform: uppercase;
        }

        .table-matriz { margin-bottom: 0; }
        .table-matriz th { 
            background: #eeeeee !important; 
            font-size: 0.65rem; 
            border: 1px solid #dee2e6;
            vertical-align: middle;
            text-align: center;
            min-width: 100px;
        }
        .table-matriz td { 
            border: 1px solid #dee2e6; 
            text-align: center; 
            padding: 4px;
            font-size: 0.75rem;
        }
        .sticky-col { 
            position: sticky; 
            left: 0; 
            background: #f8fafc !important; 
            font-weight: bold; 
            z-index: 2;
            min-width: 150px !important;
        }
        
        .form-check-input { cursor: pointer; width: 1.2em; height: 1.2em; }
        .form-check-input:checked { background-color: #198754; border-color: #198754; }
    </style>
</head>
<body>

<div class="main-content">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="fw-bold m-0"><i class="bi bi-building me-2"></i>MATRIZ DE EMPRESAS</h4>
        <div>
            <button class="btn btn-sm btn-outline-dark" onclick="addCol()"><i class="bi bi-plus-lg"></i> Añadir Empresa</button>
        </div>
    </div>

    <div class="table-container">
        <div class="header-orange">EMPRESA</div>
        <div class="table-responsive">
            <table class="table table-sm table-matriz table-hover">
                <thead id="thead-empresas">
                    </thead>
                <tbody id="tbody-parametros">
                    </tbody>
            </table>
        </div>
    </div>
    <p class="text-muted mt-2 small">* Los cambios se guardan automáticamente al marcar/desmarcar.</p>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, onValue, update, push } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const config = { databaseURL: "https://abcservers-2927d-default-rtdb.firebaseio.com/" };
    const db = getDatabase(initializeApp(config));

    // Lista de parámetros fija según tu imagen
    const PARAMETROS = [
        "FRANQUICIA", "ACF", "GR", "OMA", "P57", "PINGOL", "PINPJ", "PPJ", "PUMO", "SERMID", "PASO PAINT"
    ];

    let empresas = {};

    // Escuchar cambios en Firebase
    onValue(ref(db, 'empresas_matriz'), (snapshot) => {
        empresas = snapshot.val() || {};
        renderMatriz();
    });

    function renderMatriz() {
        const thead = document.getElementById("thead-empresas");
        const tbody = document.getElementById("tbody-parametros");
        const empKeys = Object.keys(empresas);

        // Render Encabezados
        let headHtml = `<tr><th class="sticky-col">PARÁMETRO / EMPRESA</th>`;
        empKeys.forEach(key => {
            headHtml += `<th>${empresas[key].nombre}</th>`;
        });
        headHtml += `</tr>`;
        thead.innerHTML = headHtml;

        // Render Filas
        let bodyHtml = "";
        PARAMETROS.forEach(param => {
            bodyHtml += `<tr><td class="sticky-col text-start">${param}</td>`;
            empKeys.forEach(empId => {
                const isActive = empresas[empId].activos && empresas[empId].activos[param];
                bodyHtml += `
                    <td>
                        <input class="form-check-input" type="checkbox" 
                            ${isActive ? 'checked' : ''} 
                            onchange="toggleParam('${empId}', '${param}', this.checked)">
                    </td>`;
            });
            bodyHtml += `</tr>`;
        });
        tbody.innerHTML = bodyHtml;
    }

    // Guardar estado del checkbox
    window.toggleParam = (empId, param, value) => {
        const updates = {};
        updates[`/empresas_matriz/${empId}/activos/${param}`] = value;
        update(ref(db), updates);
    };

    // Función para añadir nueva empresa (Columna)
    window.addCol = async () => {
        const { value: name } = await Swal.fire({
            title: 'Nueva Empresa',
            input: 'text',
            inputLabel: 'Nombre de la columna (Empresa)',
            showCancelButton: true
        });

        if (name) {
            const newEmpRef = push(ref(db, 'empresas_matriz'));
            update(newEmpRef, {
                nombre: name.toUpperCase(),
                activos: {}
            });
        }
    };
</script>

</body>
</html>
